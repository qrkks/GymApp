name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Create .env file on server
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          cd /opt/gymapp
          cat > .env << EOL
        # Production environment variables
        AUTH_SECRET=${{ secrets.AUTH_SECRET }}
        NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
        DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
        DATABASE_PATH=/app/db/db.production.sqlite3
        EOL
        EOF

    - name: Deploy to server
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          cd /opt/gymapp

          # Stop existing containers
          cd frontend/deploy
          docker compose down || true

          # Pull latest code (if using git)
          cd /opt/gymapp
          git pull origin main || true

          # Build and deploy
          cd frontend/deploy
          docker compose pull || true
          docker compose up -d --build

          # Wait for services to start
          sleep 30

          # Check status
          docker compose ps
        EOF

    - name: Health check
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          # Wait a bit more for the application to fully start
          sleep 30

          # Test health endpoint
          if curl -f -k https://${{ secrets.DOMAIN_NAME }}/api/health; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi
        EOF