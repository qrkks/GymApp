name: Build and Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify Dockerfile exists
        working-directory: ./backend
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Error: Dockerfile not found!"
            exit 1
          fi

      - name: Create .env file
        working-directory: ./backend
        run: |
          echo "${{ secrets.ENV_FILE_CONTENT }}" > .env

      - name: Build Docker image
        working-directory: ./backend
        run: docker build -t gymapp-backend:latest .

      - name: Save Docker image as tar
        working-directory: ./backend
        run: docker save -o gymapp-backend.tar gymapp-backend:latest

      - name: Change ownership and permissions of files
        working-directory: ./backend
        run: |
          sudo chown $USER:$USER gymapp-backend.tar .env
          chmod 644 gymapp-backend.tar .env

      - name: Ensure Target Directory Exists on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            mkdir -p /home/${{ secrets.SERVER_USER }}/app/
            chmod 755 /home/${{ secrets.SERVER_USER }}/app/

      - name: Transfer files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          source: "./backend/gymapp-backend.tar,./backend/.env"
          target: "/home/${{ secrets.SERVER_USER }}/app/"
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          debug: true

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 等待文件传输完成
            max_retries=5
            counter=0
            while [ ! -f /home/${{ secrets.SERVER_USER }}/app/gymapp-backend.tar ] && [ $counter -lt $max_retries ]; do
              echo "Waiting for gymapp-backend.tar to be available..."
              sleep 2
              counter=$((counter+1))
            done
            if [ ! -f /home/${{ secrets.SERVER_USER }}/app/gymapp-backend.tar ]; then
              echo "Error: gymapp-backend.tar not found after waiting."
              exit 1
            fi

            if [ ! -f /home/${{ secrets.SERVER_USER }}/app/.env ]; then
              echo "Error: .env file not found!"
              exit 1
            fi

            docker load -i /home/${{ secrets.SERVER_USER }}/app/gymapp-backend.tar
            docker stop gymapp-backend || true
            docker rm gymapp-backend || true
            docker run -d --name gymapp-backend -p 8000:8000 --env-file /home/${{ secrets.SERVER_USER }}/app/.env gymapp-backend:latest
