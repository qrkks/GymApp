name: Build and Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 确保前端目录存在，并删除旧 tar
      - name: Ensure Target Directories Exist on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            mkdir -p /home/${{ secrets.SERVER_USER }}/app/frontend
            rm -f /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar

      # ===== 前端：构建镜像 =====
      - name: Verify Frontend Dockerfile exists
        working-directory: ./frontend
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Error: Frontend Dockerfile not found!"
            exit 1
          fi

      - name: Build Frontend Docker image
        working-directory: ./frontend
        run: |
          docker build \
            --build-arg AUTH_SECRET=${{ secrets.AUTH_SECRET }} \
            --build-arg DATABASE_PATH=${{ secrets.DATABASE_PATH }} \
            --build-arg NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
            -t gymapp-frontend:latest .

      - name: Save Frontend Docker image as tar
        working-directory: ./frontend
        run: docker save -o gymapp-frontend.tar gymapp-frontend:latest

      - name: Change ownership and permissions of Frontend files
        working-directory: ./frontend
        run: |
          sudo chown $USER:$USER gymapp-frontend.tar
          sudo chmod 644 gymapp-frontend.tar

      - name: Move Frontend files to root directory
        run: |
          mv ./frontend/gymapp-frontend.tar .

      # ===== 传 tar 到服务器 =====
      - name: Transfer Frontend tar file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          source: "gymapp-frontend.tar"
          target: "/home/${{ secrets.SERVER_USER }}/app/frontend/"
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          debug: true

      # ===== 在服务器上部署前端（包含 API） =====
      - name: Deploy Frontend on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 部署前端
            if [ ! -f /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar ]; then
              echo "Error: gymapp-frontend.tar not found!"
              exit 1
            fi

            docker load -i /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar
            docker stop gymapp-frontend || true
            docker rm gymapp-frontend || true

            docker run -d --name gymapp-frontend -p 3000:3000 \
              --network traefik_net \
              -e AUTH_SECRET=${{ secrets.AUTH_SECRET }} \
              -e DATABASE_PATH=${{ secrets.DATABASE_PATH }} \
              -e AUTH_TRUST_HOST=true \
              -e NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              -v /home/${{ secrets.SERVER_USER }}/app/frontend/db:/app/db \
              --label 'traefik.enable=true' \
              --label 'traefik.http.routers.gymapp.rule=Host(`${{ secrets.DOMAIN_NAME }}`)' \
              --label 'traefik.http.routers.gymapp.entrypoints=websecure' \
              --label 'traefik.http.routers.gymapp.tls=true' \
              --label 'traefik.http.services.gymapp.loadbalancer.server.port=3000' \
              gymapp-frontend:latest


            sleep 5
            if [ $(docker ps -q -f name=gymapp-frontend) ]; then
              echo "Frontend container started successfully."
            else
              echo "Error: Frontend container failed to start. Checking logs..."
              docker logs gymapp-frontend
              exit 1
            fi

      # ===== 备份数据库 =====
      - name: Backup Database on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 创建备份目录
            mkdir -p /home/${{ secrets.SERVER_USER }}/backups

            # 备份数据库（如果存在）
            if [ -f /home/${{ secrets.SERVER_USER }}/app/frontend/db/db.production.sqlite3 ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="/home/${{ secrets.SERVER_USER }}/backups/backup_${TIMESTAMP}.sqlite3"
              sqlite3 /home/${{ secrets.SERVER_USER }}/app/frontend/db/db.production.sqlite3 "VACUUM INTO '$BACKUP_FILE'"
              echo "Database backup created: $BACKUP_FILE"

              # 保留最近5个备份
              ls -t /home/${{ secrets.SERVER_USER }}/backups/backup_*.sqlite3 2>/dev/null | tail -n +6 | xargs -r rm -f
              echo "Old backups cleaned up"
            else
              echo "No database file found, skipping backup"
            fi

      # ===== 清理无用 Docker 资源 =====
      - name: Cleanup Docker Resources on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            docker system prune -f
