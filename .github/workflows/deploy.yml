name: Build and Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ç¡®ä¿å‰ç«¯ç›®å½•å­˜åœ¨ï¼Œå¹¶åˆ é™¤æ—§ tar
      - name: Ensure Target Directories Exist on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            mkdir -p /home/${{ secrets.SERVER_USER }}/app/frontend
            rm -f /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar

      # ===== å‰ç«¯ï¼šæ„å»ºé•œåƒ =====
      - name: Verify Frontend Dockerfile exists
        working-directory: ./frontend
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Error: Frontend Dockerfile not found!"
            exit 1
          fi

      - name: Build Frontend Docker image
        working-directory: ./frontend
        run: |
          docker build \
            --build-arg AUTH_SECRET=${{ secrets.AUTH_SECRET }} \
            --build-arg DATABASE_PATH=${{ secrets.DATABASE_PATH }} \
            --build-arg NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
            -t gymapp-frontend:latest .

      - name: Save Frontend Docker image as tar
        working-directory: ./frontend
        run: docker save -o gymapp-frontend.tar gymapp-frontend:latest

      - name: Change ownership and permissions of Frontend files
        working-directory: ./frontend
        run: |
          sudo chown $USER:$USER gymapp-frontend.tar
          sudo chmod 644 gymapp-frontend.tar

      - name: Move Frontend files to root directory
        run: |
          mv ./frontend/gymapp-frontend.tar .

      # ===== ä¼  tar åˆ°æœåŠ¡å™¨ =====
      - name: Transfer Frontend tar file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          source: "gymapp-frontend.tar"
          target: "/home/${{ secrets.SERVER_USER }}/app/frontend/"
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          debug: true

      # ===== åˆ›å»ºéƒ¨ç½²é…ç½® =====
      - name: Create Docker Compose Config
        run: |
          # åˆ›å»ºéƒ¨ç½²ç”¨çš„ docker-compose.yml
          cat > docker-compose.deploy.yml << EOF
          version: '3.8'
          services:
            gymapp:
              image: gymapp-frontend:latest
              container_name: gymapp-frontend
              ports:
                - "3000:3000"
              environment:
                - AUTH_SECRET=${{ secrets.AUTH_SECRET }}
                - DATABASE_PATH=/app/db/db.production.sqlite3
                - NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
                - NODE_ENV=production
                - AUTH_TRUST_HOST=true
              volumes:
                - ./db:/app/db:rw
              user: "node"
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
              networks:
                - traefik_net
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.gymapp.rule=Host(\`${{ secrets.DOMAIN_NAME }}\`)"
                - "traefik.http.routers.gymapp.entrypoints=websecure"
                - "traefik.http.routers.gymapp.tls=true"
                - "traefik.http.services.gymapp.loadbalancer.server.port=3000"

          networks:
            traefik_net:
              external: true
          EOF

      # ===== ä¼ è¾“é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨ =====
      - name: Transfer Docker Compose Config
        uses: appleboy/scp-action@v0.1.7
        with:
          source: "docker-compose.deploy.yml"
          target: "/home/${{ secrets.SERVER_USER }}/app/"
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}

      # ===== åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²å‰ç«¯ï¼ˆä½¿ç”¨ Docker Composeï¼‰ =====
      - name: Deploy Frontend on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
            if [ ! -f /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar ]; then
              echo "Error: gymapp-frontend.tar not found!"
              exit 1
            fi

            if [ ! -f /home/${{ secrets.SERVER_USER }}/app/docker-compose.deploy.yml ]; then
              echo "Error: docker-compose.deploy.yml not found!"
              exit 1
            fi

            # åŠ è½½é•œåƒ
            echo "ğŸ”§ åŠ è½½ Docker é•œåƒ..."
            docker load -i /home/${{ secrets.SERVER_USER }}/app/frontend/gymapp-frontend.tar

            # è¿›å…¥åº”ç”¨ç›®å½•å¹¶å¯åŠ¨æœåŠ¡
            cd /home/${{ secrets.SERVER_USER }}/app
            echo "ğŸ³ åœæ­¢æ—§æœåŠ¡..."
            docker-compose -f docker-compose.deploy.yml down || true

            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
            docker-compose -f docker-compose.deploy.yml up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if docker-compose -f docker-compose.deploy.yml ps | grep -q "Up"; then
              echo "âœ… Frontend service started successfully!"
              echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.deploy.yml ps
              echo "ğŸ“ æœ€è¿‘çš„æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.deploy.yml logs --tail=10 gymapp
            else
              echo "âŒ Frontend service failed to start. Checking logs..."
              docker-compose -f docker-compose.deploy.yml logs gymapp
              exit 1
            fi

      # ===== å¤‡ä»½æ•°æ®åº“ =====
      - name: Backup Database on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p /home/${{ secrets.SERVER_USER }}/backups

            # å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f /home/${{ secrets.SERVER_USER }}/app/frontend/db/db.production.sqlite3 ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="/home/${{ secrets.SERVER_USER }}/backups/backup_${TIMESTAMP}.sqlite3"
              sqlite3 /home/${{ secrets.SERVER_USER }}/app/frontend/db/db.production.sqlite3 "VACUUM INTO '$BACKUP_FILE'"
              echo "Database backup created: $BACKUP_FILE"

              # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
              ls -t /home/${{ secrets.SERVER_USER }}/backups/backup_*.sqlite3 2>/dev/null | tail -n +6 | xargs -r rm -f
              echo "Old backups cleaned up"
            else
              echo "No database file found, skipping backup"
            fi

      # ===== æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œ Docker èµ„æº =====
      - name: Cleanup Files and Docker Resources on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # æ¸…ç†ä¸´æ—¶é…ç½®æ–‡ä»¶
            rm -f /home/${{ secrets.SERVER_USER }}/app/docker-compose.deploy.yml

            # æ¸…ç†æ— ç”¨ Docker èµ„æº
            docker system prune -f

      # ===== æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ =====
      - name: Cleanup Local Temp Files
        run: |
          rm -f docker-compose.deploy.yml
