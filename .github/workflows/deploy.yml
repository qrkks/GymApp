name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        load: true
        tags: gymapp-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Save Docker image as tar
      run: |
        echo "ğŸ’¾ Saving Docker image to tar file..."
        docker save gymapp-frontend:latest > gymapp-image.tar

    - name: Upload image artifact
      uses: actions/upload-artifact@v4
      with:
        name: gymapp-image
        path: gymapp-image.tar

    - name: Package deploy files
      run: |
        echo "ğŸ“¦ Packaging deploy files..."
        tar -czf deploy-files.tar -C frontend deploy

    - name: Upload deploy artifact
      uses: actions/upload-artifact@v4
      with:
        name: deploy-files
        path: deploy-files.tar

    - name: Setup SSH key for direct transfer
      run: |
        echo "ğŸ” Setting up SSH key for direct server transfer..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Transfer image and deploy files to server (direct)
      run: |
        echo "ğŸ“¤ Transferring image and deploy files directly to server..."
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no gymapp-image.tar deploy-files.tar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/

    - name: Remote load and deploy on server (direct)
      run: |
        echo "ğŸš€ Executing remote load and deploy..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          set -e
          echo "ğŸ“¦ Loading docker image..."
          docker load < ~/gymapp-image.tar
          rm -f ~/gymapp-image.tar || true

          DEPLOY_DIR="/home/${{ secrets.SERVER_USER }}/gymapp"
          mkdir -p "$DEPLOY_DIR"
          echo "ğŸ“¥ Extracting deploy files to $DEPLOY_DIR..."
          tar -xzf ~/deploy-files.tar -C "$DEPLOY_DIR"
          rm -f ~/deploy-files.tar || true

          echo "ğŸ“‹ Starting docker compose..."
          cd "$DEPLOY_DIR/frontend/deploy"
          export AUTH_SECRET="${{ secrets.AUTH_SECRET }}"
          export NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          export DATABASE_PATH="/app/db/db.production.sqlite3"
          docker compose up -d
        EOF

  deploy:
    if: false
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: gymapp-image
 
    - name: Download deploy files
      uses: actions/download-artifact@v4
      with:
        name: deploy-files

    - name: Setup SSH
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Transfer Docker image to server
      run: |
        echo "ğŸ“¤ Transferring Docker image to server..."
        scp -o StrictHostKeyChecking=no gymapp-image.tar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/

    - name: Transfer deploy files to server
      run: |
        echo "ğŸ“¤ Transferring deploy files to server..."
        scp -o StrictHostKeyChecking=no deploy-files.tar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/

    - name: Setup SSH
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Configure server for China
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          echo "ğŸ‡¨ğŸ‡³ é…ç½®æœåŠ¡å™¨ä¸ºå›½å†…ç¯å¢ƒ..."

          # Configure Docker daemon for China mirrors
          echo "ğŸ³ é…ç½®Dockeré•œåƒåŠ é€Ÿ..."
          sudo mkdir -p /etc/docker
          sudo tee /etc/docker/daemon.json > /dev/null <<'EOL'
          {
            "registry-mirrors": [
              "https://registry.docker-cn.com",
              "https://docker.mirrors.ustc.edu.cn",
              "https://hub-mirror.c.163.com",
              "https://mirror.baidubce.com",
              "https://dockerproxy.com"
            ],
            "dns": ["8.8.8.8", "114.114.114.114"]
          }
          EOL

          # Restart Docker daemon
          echo "ğŸ”„ é‡å¯DockeræœåŠ¡..."
          sudo systemctl restart docker 2>/dev/null || true
          sudo service docker restart 2>/dev/null || true

          # Configure Git for China
          echo "ğŸ“¥ é…ç½®Gitä½¿ç”¨å›½å†…é•œåƒ..."
          git config --global url."https://github.com.cnpmjs.org/".insteadOf "https://github.com/"

          # Test Docker daemon status (avoid pulling external images on domestic servers)
          echo "ğŸ§ª æµ‹è¯•Dockerå®ˆæŠ¤è¿›ç¨‹çŠ¶æ€..."
          if docker info > /dev/null 2>&1; then
            echo "âœ… Dockerå®ˆæŠ¤è¿›ç¨‹è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸ Dockerå®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œæˆ–æ— æ³•è®¿é—® - è¯·æ£€æŸ¥DockeræœåŠ¡"
          fi

          echo "âœ… æœåŠ¡å™¨é…ç½®å®Œæˆ"
        EOF

    - name: Deploy to server
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          # Load the pre-built Docker image
          echo "ğŸ“¦ Loading Docker image from transferred tar file..."
          if [ -f "~/gymapp-image.tar" ]; then
            docker load < ~/gymapp-image.tar
            echo "âœ… Docker image loaded successfully"
            rm ~/gymapp-image.tar
          else
            echo "âŒ Docker image tar file not found"
            exit 1
          fi

          # Define deployment directory (use SERVER_USER variable for username)
          DEPLOY_DIR="/home/${{ secrets.SERVER_USER }}/gymapp"

          echo "ğŸ“ Deployment directory: $DEPLOY_DIR"

          # Create directory if it doesn't exist
          if [ ! -d "$DEPLOY_DIR" ]; then
            echo "ğŸ“ Creating deployment directory..."
            mkdir -p "$DEPLOY_DIR" || exit 1
          fi

          cd "$DEPLOY_DIR"

          # Extract deploy files (provided by CI) into frontend/
          echo "ğŸ“¥ Extracting deploy files into $DEPLOY_DIR/frontend..."
          if [ -f "~/deploy-files.tar" ]; then
            mkdir -p frontend
            tar -xzf ~/deploy-files.tar -C frontend
            echo "âœ… Deploy files extracted to $DEPLOY_DIR/frontend/deploy"
            rm ~/deploy-files.tar
          else
            echo "âš ï¸ deploy-files.tar not found on server; ensure CI uploaded the artifact"
          fi

          # Set environment variables directly
          export AUTH_SECRET="${{ secrets.AUTH_SECRET }}"
          export NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          export DATABASE_PATH="/app/db/db.production.sqlite3"

          echo "âœ… Environment variables set:"
          echo "ğŸ” AUTH_SECRET: [HIDDEN - ${#AUTH_SECRET} chars]"
          echo "ğŸŒ NEXTAUTH_URL: $NEXTAUTH_URL"
          echo "ğŸ  DOMAIN_NAME: $DOMAIN_NAME"
          echo "ğŸ—„ï¸  DATABASE_PATH: $DATABASE_PATH"

          # Stop existing containers
          echo ""
          echo "ğŸ›‘ Stopping existing containers..."
          cd frontend/deploy
          docker compose down || true
          cd "$DEPLOY_DIR"

          # Deploy with environment variables
          echo ""
          echo "ğŸ³ Starting Docker containers..."
          cd frontend/deploy

          # Export variables for docker compose
          export AUTH_SECRET NEXTAUTH_URL DOMAIN_NAME DATABASE_PATH

          echo "ğŸ”§ Docker Compose environment:"
          echo "AUTH_SECRET: $AUTH_SECRET"
          echo "NEXTAUTH_URL: $NEXTAUTH_URL"
          echo "DOMAIN_NAME: $DOMAIN_NAME"

          # Verify the loaded image is available
          echo "ğŸ” Verifying Docker image..."
          if docker images | grep -q gymapp-frontend; then
            echo "âœ… Docker image is available locally"
          else
            echo "âŒ Docker image not found, exiting..."
            exit 1
          fi

          # Run containers (without --build since we have the image)
          echo "ğŸ³ Starting containers with pre-built image..."
          docker compose up -d

          echo ""
          echo "â³ Waiting for application to start..."
          sleep 10

          echo ""
          echo "ğŸ“Š Container status:"
          docker compose ps

          echo ""
          echo "ğŸ” Checking container health:"
          if docker ps | grep -q gymapp-frontend; then
            echo "âœ… Container is running"

            echo ""
            echo "ğŸ“‹ Container environment variables:"
            docker exec gymapp-frontend env | grep -E "(AUTH_SECRET|NEXTAUTH_URL|DOMAIN_NAME|NODE_ENV|DATABASE_PATH)" | sed 's/AUTH_SECRET=.*/AUTH_SECRET=[HIDDEN]/' || echo "âŒ Could not read env vars"

            echo ""
            echo "ğŸ¥ Testing internal health check:"
            docker exec gymapp-frontend curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || echo "âŒ Internal health check failed"

            echo ""
            echo "ğŸ“ Recent application logs:"
            docker logs gymapp-frontend --tail 10 2>&1 | head -20

            echo ""
            echo "ğŸ” Checking if Next.js is listening on port 3000:"
            docker exec gymapp-frontend netstat -tlnp | grep :3000 || echo "âŒ Port 3000 not listening"
          else
            echo "âŒ Container is not running"
            echo "ğŸ“ Docker logs:"
            docker logs gymapp-frontend 2>&1 | tail -20 || echo "No logs available"
          fi
        EOF

    - name: Health check
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
          echo "ğŸ” Starting comprehensive health check..."
          echo "=========================================="

          # Wait for application to fully start
          echo "â³ Waiting additional time for app startup..."
          sleep 20

          # 1. Check container status
          echo ""
          echo "ğŸ“Š === CONTAINER STATUS ==="
          docker ps --filter name=gymapp-frontend --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          # 2. Check Docker networks
          echo ""
          echo "ğŸŒ === DOCKER NETWORKS ==="
          docker network ls | grep traefik || echo "traefik_net not found"

          # 3. Test DNS resolution
          echo ""
          echo "ğŸŒ === DNS RESOLUTION ==="
          nslookup ${{ secrets.DOMAIN_NAME }} || echo "DNS resolution failed"
          ping -c 2 ${{ secrets.DOMAIN_NAME }} || echo "Ping failed"

          # 4. Test external connectivity
          echo ""
          echo "ğŸ”— === EXTERNAL CONNECTIVITY TEST ==="
          echo "Testing HTTPS connection to ${{ secrets.DOMAIN_NAME }}:443"
          timeout 10 openssl s_client -connect ${{ secrets.DOMAIN_NAME }}:443 -servername ${{ secrets.DOMAIN_NAME }} </dev/null 2>/dev/null | openssl x509 -noout -dates 2>/dev/null || echo "SSL certificate check failed"

          # 5. Test Traefik
          echo ""
          echo "ğŸ”„ === TRAEFIK STATUS ==="
          docker ps --filter name=traefik --format "table {{.Names}}\t{{.Status}}" || echo "Traefik container not found"

          if docker ps | grep -q traefik; then
            echo "Traefik logs:"
            docker logs traefik --tail 5 2>&1 || echo "Could not read Traefik logs"
          fi

          # 6. Detailed container diagnostics
          echo ""
          echo "ğŸ” === CONTAINER DIAGNOSTICS ==="
          if docker ps | grep -q gymapp-frontend; then
            echo "âœ… Container is running"

            # Check resource usage
            echo ""
            echo "ğŸ“ˆ Container resource usage:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" gymapp-frontend

            # Check listening ports
            echo ""
            echo "ğŸ”Œ Container listening ports:"
            docker exec gymapp-frontend netstat -tlnp 2>/dev/null | grep LISTEN || echo "No listening ports found"

            # Check processes
            echo ""
            echo "âš™ï¸  Container processes:"
            docker exec gymapp-frontend ps aux | head -10

            # Check Next.js build
            echo ""
            echo "ğŸ—ï¸  Checking Next.js build:"
            docker exec gymapp-frontend ls -la /app/.next 2>/dev/null || echo ".next directory not found"

            # Check database
            echo ""
            echo "ğŸ—„ï¸  Database check:"
            docker exec gymapp-frontend ls -la /app/db/ 2>/dev/null || echo "Database directory not accessible"

          else
            echo "âŒ Container is NOT running"
            echo "ğŸ“ Full container logs:"
            docker logs gymapp-frontend 2>&1 | tail -50 || echo "No container logs available"
            exit 1
          fi

          # 7. Application logs
          echo ""
          echo "ğŸ“ === APPLICATION LOGS (last 30 lines) ==="
          docker logs gymapp-frontend --tail 30 2>&1

          # 8. Internal health check
          echo ""
          echo "ğŸ¥ === INTERNAL HEALTH CHECK ==="
          echo "Testing http://localhost:3000/api/health"
          INTERNAL_STATUS=$(docker exec gymapp-frontend curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health 2>/dev/null || echo "000")
          if [ "$INTERNAL_STATUS" = "200" ]; then
            echo "âœ… Internal health check PASSED (HTTP $INTERNAL_STATUS)"
          else
            echo "âŒ Internal health check FAILED (HTTP $INTERNAL_STATUS)"
            docker exec gymapp-frontend curl -v http://localhost:3000/api/health 2>&1 || echo "Curl command failed"
          fi

          # 9. External health check
          echo ""
          echo "ğŸŒ === EXTERNAL HEALTH CHECK ==="
          echo "Testing https://${{ secrets.DOMAIN_NAME }}/api/health"
          EXTERNAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -k https://${{ secrets.DOMAIN_NAME }}/api/health 2>/dev/null || echo "000")
          if [ "$EXTERNAL_STATUS" = "200" ]; then
            echo "âœ… External health check PASSED (HTTP $EXTERNAL_STATUS)"
          else
            echo "âŒ External health check FAILED (HTTP $EXTERNAL_STATUS)"
            echo "Full curl output:"
            curl -v -k --max-time 10 https://${{ secrets.DOMAIN_NAME }}/api/health 2>&1 || echo "Curl command failed"
          fi

          # 10. Environment variables summary
          echo ""
          echo "ğŸ”§ === ENVIRONMENT VARIABLES SUMMARY ==="
          docker exec gymapp-frontend env | grep -E "(AUTH_SECRET|NEXTAUTH_URL|DOMAIN_NAME|NODE_ENV|DATABASE_PATH)" | \
            sed 's/AUTH_SECRET=.*/AUTH_SECRET=[HIDDEN]/' | \
            sed 's/\(NEXTAUTH_URL=\)\(.*\)/\1[URL_SET]/' | \
            sed 's/\(DOMAIN_NAME=\)\(.*\)/\1[DOMAIN_SET]/' || echo "Could not read environment variables"

          # Troubleshooting guide
          echo ""
          echo "ğŸ”§ === TROUBLESHOOTING GUIDE ==="
          if [ "$INTERNAL_STATUS" != "200" ]; then
            echo "âŒ INTERNAL HEALTH CHECK FAILED (HTTP $INTERNAL_STATUS)"
            echo "   Possible causes:"
            echo "   1. AUTH_SECRET not set correctly"
            echo "   2. Database not initialized"
            echo "   3. Next.js application failed to start"
            echo "   4. Port 3000 not bound correctly"
            echo "   â†’ Check application logs above for 'Missing AUTH_SECRET' errors"
          fi

          if [ "$EXTERNAL_STATUS" != "200" ]; then
            echo "âŒ EXTERNAL HEALTH CHECK FAILED (HTTP $EXTERNAL_STATUS)"
            echo "   Possible causes:"
            echo "   1. Traefik reverse proxy not configured"
            echo "   2. SSL certificate issues"
            echo "   3. DNS not pointing to server"
            echo "   4. Firewall blocking HTTPS traffic"
            echo "   â†’ Check if ${{ secrets.DOMAIN_NAME }} resolves correctly"
          fi

          # Final verdict
          echo ""
          echo "ğŸ¯ === FINAL VERDICT ==="
          if [ "$INTERNAL_STATUS" = "200" ] && [ "$EXTERNAL_STATUS" = "200" ]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL - All checks passed!"
            echo "ğŸ‰ Your application is now live at https://${{ secrets.DOMAIN_NAME }}"
            exit 0
          else
            echo "âŒ DEPLOYMENT FAILED"
            echo ""
            echo "ğŸ“ SUPPORT INFORMATION:"
            echo "   - Check GitHub Actions logs for complete diagnostic output"
            echo "   - Common fixes:"
            echo "     1. Verify AUTH_SECRET in GitHub Secrets is a valid base64 string"
            echo "     2. Ensure NEXTAUTH_URL matches your domain"
            echo "     3. Check that DOMAIN_NAME has correct DNS records"
            echo "     4. Verify Traefik is running and configured correctly"
            exit 1
          fi
        EOF