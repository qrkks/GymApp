name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        load: true
        tags: gymapp-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Save Docker image as tar
      run: |
        echo "ğŸ’¾ Saving Docker image to tar file..."
        docker save gymapp-frontend:latest > gymapp-image.tar

    - name: Package deploy files
      run: |
        echo "ğŸ“¦ Packaging deploy files..."
        # æ‰“åŒ… docker-compose.yml å’Œ .env.example
        tar -czf deploy-files.tar \
          -C frontend \
          docker-compose.yml \
          .env.example

    - name: Install sshpass
      run: |
        echo "ğŸ”§ Installing sshpass for password-based SSH..."
        sudo apt-get update
        sudo apt-get install -y sshpass

    - name: Transfer files to server
      run: |
        echo "ğŸ“¤ Transferring files to server..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp \
          -o StrictHostKeyChecking=no \
          gymapp-image.tar \
          deploy-files.tar \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/

    - name: Deploy on server
      run: |
        echo "ğŸš€ Deploying on server..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          set -e

          DEPLOY_DIR="/home/${{ secrets.SERVER_USER }}/gymapp"
          FRONTEND_DIR="$DEPLOY_DIR/frontend"

          # ============================================
          # åœæ­¢æ—§å®¹å™¨ï¼ˆä¸ºåŠ è½½æ–°é•œåƒåšå‡†å¤‡ï¼‰
          # ============================================
          echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
          mkdir -p "$FRONTEND_DIR"
          if [ -f "$FRONTEND_DIR/docker-compose.yml" ]; then
            cd "$FRONTEND_DIR"
            docker compose down 2>/dev/null || true
            echo "âœ… æ—§å®¹å™¨å·²åœæ­¢"
          else
            echo "â„¹ï¸  é¦–æ¬¡éƒ¨ç½²ï¼Œæ²¡æœ‰æ—§å®¹å™¨éœ€è¦åœæ­¢"
          fi

          # ============================================
          # åŠ è½½æ–°é•œåƒ
          # ============================================
          echo ""
          echo "ğŸ“¦ Loading Docker image..."
          docker load < ~/gymapp-image.tar
          rm -f ~/gymapp-image.tar || true

          echo "ğŸ“ Setting up deployment directory..."
          mkdir -p "$FRONTEND_DIR"

          echo "ğŸ“¥ Extracting deploy files..."
          tar -xzf ~/deploy-files.tar -C "$FRONTEND_DIR"
          rm -f ~/deploy-files.tar || true

          cd "$FRONTEND_DIR"

          # ============================================
          # .env æ–‡ä»¶å¤„ç†ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
          # ============================================
          echo ""
          echo "ğŸ” æ£€æŸ¥ .env æ–‡ä»¶..."
          echo "   å½“å‰ç›®å½•: $(pwd)"
          echo "   æŸ¥æ‰¾è·¯å¾„: $FRONTEND_DIR/.env"
          echo ""
          echo "ğŸ“‚ ç›®å½•å†…å®¹:"
          ls -la "$FRONTEND_DIR" | head -20 || true
          echo ""
          
          # æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f .env ]; then
            echo "âš ï¸  .env æ–‡ä»¶ä¸å­˜åœ¨äºé¢„æœŸä½ç½®: $FRONTEND_DIR/.env"
            echo ""
            echo "ğŸ” æœç´¢å…¶ä»–ä½ç½®çš„ .env æ–‡ä»¶..."
            find "$DEPLOY_DIR" -name ".env" -type f 2>/dev/null | head -5 || echo "   æœªæ‰¾åˆ°å…¶ä»– .env æ–‡ä»¶"
            echo ""
            echo "âš ï¸  æ­£åœ¨åˆ›å»ºæ¨¡æ¿..."
            
            if [ -f .env.example ]; then
              cp .env.example .env
              chmod 600 .env
              echo "âœ… å·²ä» .env.example åˆ›å»º .env æ–‡ä»¶"
              echo ""
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼š.env æ–‡ä»¶åŒ…å«æ¨¡æ¿å ä½ç¬¦"
              echo ""
              echo "ğŸ“‹ è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
              echo "   1. SSH åˆ°æœåŠ¡å™¨: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}"
              echo "   2. è¿›å…¥ç›®å½•: cd $FRONTEND_DIR"
              echo "   3. ç¼–è¾‘ .env æ–‡ä»¶: nano .env"
              echo "   4. å¡«å…¥çœŸå®å€¼ï¼ˆæ›¿æ¢æ‰€æœ‰ 'your-xxx-here' å ä½ç¬¦ï¼‰"
              echo "   5. ä¿å­˜åé‡æ–°è¿è¡Œéƒ¨ç½²æˆ–æ‰‹åŠ¨å¯åŠ¨: docker compose up -d"
              echo ""
              echo "ğŸ“ å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š"
              echo "   - AUTH_SECRET: NextAuth è®¤è¯å¯†é’¥"
              echo "   - POSTGRES_PASSWORD: PostgreSQL æ•°æ®åº“å¯†ç "
              echo "   - NEXTAUTH_URL: åº”ç”¨ URL (å¦‚: https://yourdomain.com)"
              echo "   - DOMAIN_NAME: åŸŸå (å¦‚: yourdomain.com)"
              echo ""
              exit 1
            else
              echo "âŒ é”™è¯¯ï¼š.env.example æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âœ… æ‰¾åˆ° .env æ–‡ä»¶: $FRONTEND_DIR/.env"
            echo "   æ–‡ä»¶å¤§å°: $(stat -c%s .env 2>/dev/null || stat -f%z .env 2>/dev/null || echo 'unknown') å­—èŠ‚"
            echo "   æ–‡ä»¶æƒé™: $(ls -l .env | awk '{print $1}')"
            echo ""
          fi

          # éªŒè¯ .env æ–‡ä»¶æ˜¯å¦åŒ…å«å ä½ç¬¦
          echo "ğŸ” éªŒè¯ .env æ–‡ä»¶å†…å®¹..."
          if grep -q "your-.*-here\|è¯·æ›¿æ¢" .env 2>/dev/null; then
            echo ""
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼š.env æ–‡ä»¶åŒ…å«æ¨¡æ¿å ä½ç¬¦"
            echo ""
            echo "ğŸ“‹ å‘ç°ä»¥ä¸‹å ä½ç¬¦:"
            grep -n "your-.*-here\|è¯·æ›¿æ¢" .env 2>/dev/null | head -10 || true
            echo ""
            echo "ğŸ“‹ è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
            echo "   1. SSH åˆ°æœåŠ¡å™¨: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}"
            echo "   2. è¿›å…¥ç›®å½•: cd $FRONTEND_DIR"
            echo "   3. ç¼–è¾‘ .env æ–‡ä»¶: nano .env"
            echo "   4. å¡«å…¥çœŸå®å€¼ï¼ˆæ›¿æ¢æ‰€æœ‰ 'your-xxx-here' å ä½ç¬¦ï¼‰"
            echo "   5. ä¿å­˜åé‡æ–°è¿è¡Œéƒ¨ç½²æˆ–æ‰‹åŠ¨å¯åŠ¨: docker compose up -d"
            echo ""
            exit 1
          fi

          # ç¡®ä¿ .env æ–‡ä»¶æƒé™æ­£ç¡®
          chmod 600 .env

          echo "âœ… .env æ–‡ä»¶éªŒè¯é€šè¿‡"

          # ============================================
          # éƒ¨ç½²æœåŠ¡
          # ============================================
          echo ""
          echo "ğŸ³ å¯åŠ¨ Docker Compose æœåŠ¡..."
          
          # éªŒè¯ Docker é•œåƒæ˜¯å¦å­˜åœ¨
          if ! docker images | grep -q gymapp-frontend; then
            echo "âŒ Docker é•œåƒæœªæ‰¾åˆ°"
            exit 1
          fi

          # ä½¿ç”¨ docker compose å¯åŠ¨æœåŠ¡
          # .env æ–‡ä»¶ä¼šè‡ªåŠ¨åŠ è½½ï¼ˆé€šè¿‡ env_file é…ç½®ï¼‰
          docker compose up -d

          echo ""
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15

          echo ""
          echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
          docker compose ps

          # ============================================
          # å¥åº·æ£€æŸ¥
          # ============================================
          echo ""
          echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
          
          if docker ps | grep -q gymapp-frontend; then
            echo "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ"
            
            # æ£€æŸ¥å®¹å™¨å†…éƒ¨å¥åº·æ£€æŸ¥
            echo ""
            echo "ğŸ” æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
            HEALTH_STATUS=$(docker exec gymapp-frontend curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health 2>/dev/null || echo "000")
            
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡ (HTTP $HEALTH_STATUS)"
            else
              echo "âš ï¸  åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $HEALTH_STATUS)"
              echo "ğŸ“ æŸ¥çœ‹åº”ç”¨æ—¥å¿—:"
              docker compose logs gymapp --tail 20
            fi

            # æ˜¾ç¤ºç¯å¢ƒå˜é‡æ‘˜è¦ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
            echo ""
            echo "ğŸ”§ ç¯å¢ƒå˜é‡æ‘˜è¦:"
            docker exec gymapp-frontend env | grep -E "(NODE_ENV|NEXTAUTH_URL|DOMAIN_NAME)" | \
              sed 's/NEXTAUTH_URL=.*/NEXTAUTH_URL=[SET]/' | \
              sed 's/DOMAIN_NAME=.*/DOMAIN_NAME=[SET]/' || true

          else
            echo "âŒ å®¹å™¨æœªè¿è¡Œ"
            echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—:"
            docker compose logs
            exit 1
          fi

          # ============================================
          # æ¸…ç†æ—§é•œåƒå’Œæœªä½¿ç”¨çš„èµ„æº
          # ============================================
          echo ""
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒå’Œæœªä½¿ç”¨çš„èµ„æº..."
          
          # æ˜¾ç¤ºæ¸…ç†å‰çš„é•œåƒä¿¡æ¯
          echo "ğŸ“Š æ¸…ç†å‰çš„é•œåƒ:"
          docker images gymapp-frontend --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}" || true
          
          # æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆdangling imagesï¼‰- è¿™äº›æ˜¯æ—§ç‰ˆæœ¬çš„é•œåƒï¼Œæ ‡ç­¾å·²è¢«æ–°é•œåƒæ›¿æ¢
          DANGLING_IMAGES=$(docker images -f "dangling=true" -q)
          if [ -n "$DANGLING_IMAGES" ]; then
            echo "ğŸ—‘ï¸  å‘ç°æ‚¬ç©ºé•œåƒï¼Œæ­£åœ¨æ¸…ç†..."
            docker rmi $DANGLING_IMAGES 2>/dev/null || echo "   éƒ¨åˆ†æ‚¬ç©ºé•œåƒå¯èƒ½ä»åœ¨ä½¿ç”¨ä¸­ï¼Œè·³è¿‡"
          else
            echo "âœ… æ²¡æœ‰æ‚¬ç©ºé•œåƒéœ€è¦æ¸…ç†"
          fi
          
          # æ¸…ç†æ—§çš„ gymapp-frontend é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„ 2 ä¸ªç‰ˆæœ¬ï¼‰
          # è·å–æ‰€æœ‰ gymapp-frontend é•œåƒï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œåˆ é™¤æœ€æ—§çš„
          OLD_IMAGES=$(docker images gymapp-frontend --format "{{.ID}}" | tail -n +3)
          if [ -n "$OLD_IMAGES" ]; then
            echo "ğŸ—‘ï¸  å‘ç°æ—§ç‰ˆæœ¬çš„ gymapp-frontend é•œåƒï¼Œæ­£åœ¨æ¸…ç†..."
            for IMAGE_ID in $OLD_IMAGES; do
              # æ£€æŸ¥é•œåƒæ˜¯å¦æ­£åœ¨è¢«å®¹å™¨ä½¿ç”¨
              if ! docker ps -a --format "{{.Image}}" | grep -q "$IMAGE_ID"; then
                echo "   åˆ é™¤æ—§é•œåƒ: $IMAGE_ID"
                docker rmi "$IMAGE_ID" 2>/dev/null || echo "   æ— æ³•åˆ é™¤é•œåƒ $IMAGE_IDï¼ˆå¯èƒ½ä»åœ¨ä½¿ç”¨ä¸­ï¼‰"
              else
                echo "   è·³è¿‡æ­£åœ¨ä½¿ç”¨çš„é•œåƒ: $IMAGE_ID"
              fi
            done
          else
            echo "âœ… æ²¡æœ‰æ—§ç‰ˆæœ¬çš„é•œåƒéœ€è¦æ¸…ç†"
          fi
          
          # æ¸…ç†æœªä½¿ç”¨çš„æ„å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„æ„å»ºç¼“å­˜..."
          docker builder prune -f --filter "until=24h" || true
          
          # æ˜¾ç¤ºæ¸…ç†åçš„é•œåƒä¿¡æ¯
          echo ""
          echo "ğŸ“Š æ¸…ç†åçš„é•œåƒ:"
          docker images gymapp-frontend --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}" || true
          
          # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo ""
          echo "ğŸ’¾ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          docker system df

          echo ""
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        EOF
