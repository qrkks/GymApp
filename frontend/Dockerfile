# ============================================
# æ„å»ºé˜¶æ®µ
# ============================================
FROM node:22-bookworm-slim AS builder

WORKDIR /app

# å®‰è£…æ„å»ºæ—¶éœ€è¦çš„ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    curl \
  && rm -rf /var/lib/apt/lists/*

# å¯ç”¨ pnpm
RUN corepack enable pnpm

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜å±‚ï¼‰
COPY package.json pnpm-lock.yaml* ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œæ„å»ºæ—¶éœ€è¦ï¼‰
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æ„å»ºé…ç½®æ–‡ä»¶ï¼ˆåœ¨å¤åˆ¶æºç å‰ï¼Œåˆ©ç”¨ç¼“å­˜ï¼‰
COPY next.config.mjs tsconfig.json postcss.config.mjs tailwind.config.js ./
COPY jsconfig.json ./

# å¤åˆ¶æºç ï¼ˆæ„å»ºæ—¶ä¸éœ€è¦ç¯å¢ƒå˜é‡ï¼ŒNext.js ä¼šåœ¨è¿è¡Œæ—¶è¯»å–ï¼‰
COPY . .
# ç¡®ä¿ public ç›®å½•å­˜åœ¨ï¼ˆNext.js éœ€è¦ï¼Œå³ä½¿ä¸ºç©ºï¼‰
RUN mkdir -p public || true

# è®¾ç½®æ„å»ºæ—¶çš„è™šæ‹Ÿç¯å¢ƒå˜é‡ï¼ˆé¿å…æ„å»ºæ—¶æ£€æŸ¥å¤±è´¥ï¼‰
# è¿™äº›å€¼ä¸ä¼šå½±å“æ„å»ºç»“æœï¼Œåªæ˜¯é¿å…æŠ¥é”™
ENV AUTH_SECRET=build-time-placeholder
ENV NEXTAUTH_URL=http://localhost:3000
ENV DATABASE_URL=postgresql://placeholder:placeholder@placeholder:5432/placeholder
ENV NODE_ENV=production

# æ„å»ºåº”ç”¨ï¼ˆNext.js æ„å»ºä¸ä¾èµ–è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ï¼‰
RUN pnpm run build

# æ¸…ç†æ„å»ºç¼“å­˜å’Œå¼€å‘ä¾èµ–
RUN pnpm store prune && \
    rm -rf .next/cache

# ============================================
# è¿è¡Œæ—¶é˜¶æ®µ
# ============================================
FROM node:22-bookworm-slim AS runner

WORKDIR /app

# å®‰è£…è¿è¡Œæ—¶æ‰€éœ€çš„æœ€å°ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-client \
    curl \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

# å¯ç”¨ pnpmï¼ˆç”¨äºè¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼‰
RUN corepack enable pnpm

# åˆ›å»ºé root ç”¨æˆ·
RUN groupadd --gid 1001 nodejs || true \
  && useradd --uid 1001 --gid nodejs --shell /bin/bash --create-home nextjs || true

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=0.0.0.0
ENV NEXT_TELEMETRY_DISABLED=1

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
# standalone æ¨¡å¼å·²ç»åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„ä¾èµ–å’Œæ–‡ä»¶

# å¤åˆ¶ standalone æ„å»ºäº§ç‰©ï¼ˆåŒ…å«æ‰€æœ‰è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶ï¼‰
# standalone ç›®å½•ç»“æ„ï¼šåŒ…å« server.jsã€package.jsonã€node_modules ç­‰
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
# å¤åˆ¶ public ç›®å½•ï¼ˆæ„å»ºé˜¶æ®µå·²ç¡®ä¿å­˜åœ¨ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# å¤åˆ¶è¿è¡Œæ—¶éœ€è¦çš„é…ç½®å’Œè„šæœ¬ï¼ˆstandalone æ¨¡å¼ä¸åŒ…å«è¿™äº›ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/next.config.mjs ./
COPY --from=builder --chown=nextjs:nodejs /app/scripts ./scripts
COPY --from=builder --chown=nextjs:nodejs /app/drizzle.config.ts ./
COPY --from=builder --chown=nextjs:nodejs /app/drizzle ./drizzle

# å¤åˆ¶ package.json å’Œ pnpm-lock.yamlï¼ˆç”¨äºå®‰è£… drizzle-kitï¼‰
COPY --from=builder /app/package.json ./package.json
# å¤åˆ¶ pnpm-lock.yamlï¼ˆå¦‚æœå­˜åœ¨ï¼‰- ä½¿ç”¨ BuildKit mount å¤„ç†å¯é€‰æ–‡ä»¶
USER root
RUN --mount=from=builder,source=/app,target=/tmp/builder \
    sh -c 'if [ -f /tmp/builder/pnpm-lock.yaml ]; then \
      cp /tmp/builder/pnpm-lock.yaml ./pnpm-lock.yaml; \
    elif ls /tmp/builder/pnpm-lock.yaml.* 1>/dev/null 2>&1; then \
      cp /tmp/builder/pnpm-lock.yaml.* ./; \
    fi' && \
    chown -R nextjs:nodejs ./pnpm-lock.yaml* 2>/dev/null || true

# ç¡®ä¿ drizzle-kit åœ¨è¿è¡Œæ—¶å¯ç”¨ï¼ˆstandalone æ¨¡å¼å¯èƒ½ä¸åŒ…å«å‘½ä»¤è¡Œå·¥å…·ï¼‰
# å¦‚æœ standalone çš„ node_modules ä¸­æ²¡æœ‰ drizzle-kitï¼Œåˆ™å®‰è£…å®ƒ
USER root
RUN if [ ! -d "node_modules/drizzle-kit" ]; then \
      echo "ğŸ“¦ å®‰è£… drizzle-kit åˆ°è¿è¡Œæ—¶ç¯å¢ƒ..."; \
      pnpm add drizzle-kit@^0.30.6 --save-prod --frozen-lockfile || \
      pnpm install drizzle-kit@^0.30.6 --save-prod || true; \
      chown -R nextjs:nodejs node_modules package.json pnpm-lock.yaml* 2>/dev/null || true; \
    fi
USER nextjs

# ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
RUN chmod +x ./scripts/start.sh || true

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

EXPOSE 3000

# ç§»é™¤å¥åº·æ£€æŸ¥ï¼Œè®©å®¹å™¨è‡ªå·±å¯åŠ¨
CMD ["./scripts/start.sh"]
