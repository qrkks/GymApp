FROM node:22-bookworm-slim

ARG AUTH_SECRET
ARG DATABASE_PATH
ARG NEXTAUTH_URL

ENV AUTH_SECRET=${AUTH_SECRET}
ENV DATABASE_PATH=${DATABASE_PATH}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV AUTH_TRUST_HOST=true
ENV NODE_ENV=production

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 make g++ sqlite3 curl \
  && rm -rf /var/lib/apt/lists/* \
  && groupadd --gid 1001 nodejs \
  && useradd --uid 1001 --gid nodejs --shell /bin/bash --create-home nextjs

# å¯ç”¨ pnpm
RUN corepack enable pnpm

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
COPY package.json pnpm-lock.yaml* ./

# å®‰è£…ä¾èµ–å¹¶é‡å»º better-sqlite3
RUN pnpm install --frozen-lockfile && \
    echo "ğŸ”§ é‡å»º better-sqlite3..." && \
    pnpm rebuild better-sqlite3 --config.build_from_source=true && \
    echo "âœ… better-sqlite3 é‡å»ºå®Œæˆ" && \
    pnpm store prune

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm run build

# åˆ›å»ºæ•°æ®åº“ç›®å½•ï¼ˆåœ¨åˆ‡æ¢ç”¨æˆ·å‰ï¼‰
RUN mkdir -p db

# è®¾ç½®æ­£ç¡®çš„æƒé™ï¼Œç¡®ä¿nextjsç”¨æˆ·å¯ä»¥è®¿é—®æ‰€æœ‰æ–‡ä»¶
RUN chown -R nextjs:nodejs /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["bash", "./scripts/start.sh"]
