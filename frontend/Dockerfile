# ======================== ä¼˜åŒ–æ„å»ºç­–ç•¥ ========================
FROM node:22-bookworm-slim

ARG AUTH_SECRET
ARG DATABASE_PATH
ARG NEXTAUTH_URL

ENV AUTH_SECRET=${AUTH_SECRET}
ENV DATABASE_PATH=${DATABASE_PATH}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV AUTH_TRUST_HOST=true
ENV NODE_ENV=production

WORKDIR /app

# 1. é¦–å…ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆæ„å»ºé˜¶æ®µéœ€è¦ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 make g++ sqlite3 curl \
  && rm -rf /var/lib/apt/lists/* \
  && groupadd --gid 1001 nodejs \
  && useradd --uid 1001 --gid nodejs --shell /bin/bash --create-home nextjs

# 2. å¯ç”¨ pnpm
RUN corepack enable pnpm

# 3. å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨Dockerå±‚ç¼“å­˜ï¼‰
COPY package.json pnpm-lock.yaml* ./

# 4. å®‰è£…æ‰€æœ‰ä¾èµ–
RUN pnpm install --frozen-lockfile && \
    echo "ğŸ”§ é‡å»º better-sqlite3..." && \
    pnpm rebuild better-sqlite3 --config.build_from_source=true && \
    echo "âœ… better-sqlite3 é‡å»ºå®Œæˆ"

# 5. å¤åˆ¶æºç ï¼ˆåœ¨ä¾èµ–ä¹‹åï¼Œæºç å˜åŒ–ä¸ä¼šå½±å“ä¾èµ–å®‰è£…ç¼“å­˜ï¼‰
COPY . .

# 6. æ„å»ºåº”ç”¨
RUN pnpm run build

# 7. åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

# 8. åˆ›å»ºæ•°æ®åº“ç›®å½•
RUN mkdir -p db

# 9. æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆå‡å°é•œåƒå¤§å°ï¼‰
RUN rm -rf /tmp/* && \
    pnpm store prune && \
    pnpm cache clean --force || true

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["./scripts/start.sh"]
