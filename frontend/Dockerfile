FROM node:22-bookworm-slim

ARG AUTH_SECRET
ARG DATABASE_PATH
ARG NEXTAUTH_URL

ENV AUTH_SECRET=${AUTH_SECRET}
ENV DATABASE_PATH=${DATABASE_PATH}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV AUTH_TRUST_HOST=true
ENV NODE_ENV=production

WORKDIR /app

# 1. native æ¨¡å—éœ€è¦çš„å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 make g++ sqlite3 \
  && rm -rf /var/lib/apt/lists/*

# 2. å…ˆæ‹·ä¾èµ–å£°æ˜ï¼ˆlock æœ‰å°±ç”¨ï¼Œæ²¡æœ‰ä¹Ÿæ— æ‰€è°“ï¼‰
COPY package.json pnpm-lock.yaml* ./

# 3. ç›´æ¥ pnpm installï¼ˆä¸åŠ  --frozen-lockfileï¼‰
RUN corepack enable pnpm \
  && pnpm install \
  && echo "ğŸ”§ é‡å»º better-sqlite3..." \
  && pnpm rebuild better-sqlite3 --config.build_from_source=true \
  && echo "âœ… better-sqlite3 é‡å»ºå®Œæˆ"

# 4. å†æ‹·æºç ï¼Œæ„å»º Next
COPY . .

RUN corepack enable pnpm && pnpm run build

# ç¡®ä¿å¯åŠ¨è„šæœ¬å¯æ‰§è¡Œ
RUN chmod +x scripts/start.sh

EXPOSE 3000

CMD ["./scripts/start.sh"]
