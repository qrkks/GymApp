# éƒ¨ç½²æŒ‡å—

## éƒ¨ç½²æ–¹å¼é€‰æ‹©

æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š

### ğŸš€ **æ¨èï¼šCI/CDè‡ªåŠ¨éƒ¨ç½²** (ç”Ÿäº§ç¯å¢ƒ)
- é€šè¿‡GitHub Actionsè‡ªåŠ¨éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨
- å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨æœåŠ¡å™¨é…ç½®
- é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨

### ğŸ”§ **æœ¬åœ°éƒ¨ç½²** (å¼€å‘/æµ‹è¯•ç¯å¢ƒ)
- ä½¿ç”¨Docker Composeåœ¨æœ¬åœ°éƒ¨ç½²
- éœ€è¦æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡å’Œæ•°æ®åº“
- é€‚åˆå¼€å‘æµ‹è¯•æˆ–å•æœºéƒ¨ç½²

## ç¯å¢ƒè¦æ±‚

- **CI/CDéƒ¨ç½²**: GitHubä»“åº“ï¼Œé…ç½®æ­£ç¡®çš„Secrets
- **æœ¬åœ°éƒ¨ç½²**: Docker & Docker Compose, Node.js 22.x

## ğŸš€ CI/CDè‡ªåŠ¨éƒ¨ç½² (æ¨è)

### 1. é…ç½®GitHub Secrets

åœ¨GitHubä»“åº“çš„ **Settings > Secrets and variables > Actions** ä¸­é…ç½®ä»¥ä¸‹secretsï¼š

```bash
SERVER_IP         # æœåŠ¡å™¨å…¬ç½‘IP (ä¾‹å¦‚: 39.107.126.13)
SERVER_USER       # SSHç”¨æˆ·å (ä¾‹å¦‚: ubuntu)
SERVER_PASSWORD   # SSHå¯†ç 
AUTH_SECRET       # NextAuthå¯†é’¥ (è¿è¡Œ: openssl rand -base64 32)
NEXTAUTH_URL      # ç”Ÿäº§ç¯å¢ƒURL (ä¾‹å¦‚: https://yourdomain.com)
DOMAIN_NAME       # åŸŸå (ä¾‹å¦‚: yourdomain.com)
```

### 2. éƒ¨ç½²æµç¨‹

```bash
# æ¨é€ä»£ç åˆ°mainåˆ†æ”¯è‡ªåŠ¨è§¦å‘éƒ¨ç½²
git add .
git commit -m "Deploy to production"
git push origin main
```

### 3. éƒ¨ç½²è¿‡ç¨‹è¯´æ˜

CI/CDä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ„å»ºé˜¶æ®µ**ï¼š
   - æ„å»ºDockeré•œåƒ
   - ä¿å­˜é•œåƒä¸ºtaræ–‡ä»¶
   - æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶

2. **ä¼ è¾“é˜¶æ®µ**ï¼š
   - é€šè¿‡SSHä¼ è¾“é•œåƒå’Œé…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
   - è‡ªåŠ¨åˆ›å»ºéƒ¨ç½²ç›®å½• `/home/{SERVER_USER}/gymapp`

3. **éƒ¨ç½²é˜¶æ®µ**ï¼š
   - åŠ è½½Dockeré•œåƒ
   - è§£å‹éƒ¨ç½²æ–‡ä»¶åˆ° `frontend` ç›®å½•
   - å¯åŠ¨Dockerå®¹å™¨
   - è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“

### 4. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
curl https://yourdomain.com/api/health

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿— (åœ¨GitHub Actionsé¡µé¢)
```

### 5. æœåŠ¡å™¨ç›®å½•ç»“æ„

éƒ¨ç½²å®ŒæˆåæœåŠ¡å™¨ä¸Šçš„ç›®å½•ç»“æ„ï¼š

```
/home/${SERVER_USER}/
â””â”€â”€ gymapp/
    â””â”€â”€ frontend/
        â””â”€â”€ deploy/           # éƒ¨ç½²æ–‡ä»¶
            â”œâ”€â”€ docker-compose.yml
            â”œâ”€â”€ deploy.sh
            â”œâ”€â”€ db/           # æ•°æ®åº“ç›®å½•
            â”‚   â””â”€â”€ db.production.sqlite3
            â””â”€â”€ ...
```

## ğŸ”§ æœ¬åœ°éƒ¨ç½² (å¼€å‘/æµ‹è¯•)

ä½¿ç”¨Docker Composeå¯åŠ¨ï¼š

```bash
# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ï¼‰
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f gymapp
```

**æ³¨æ„**: åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“ï¼Œæ— éœ€æ‰‹åŠ¨æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–å‘½ä»¤ã€‚

## ç¬¬ä¸€æ¬¡éƒ¨ç½²è¯¦æƒ…

### è‡ªåŠ¨æ•°æ®åº“åˆå§‹åŒ–æµç¨‹

1. **å®¹å™¨å¯åŠ¨æ—¶æ£€æŸ¥**:
   - æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (`/app/db/db.production.sqlite3`)
   - å¦‚æœä¸å­˜åœ¨ï¼ŒSQLiteä¼šè‡ªåŠ¨åˆ›å»ºç©ºæ•°æ®åº“æ–‡ä»¶

2. **è¡¨ç»“æ„æ£€æŸ¥**:
   - æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æœ‰è¡¨ç»“æ„
   - å¦‚æœæ²¡æœ‰è¡¨ï¼Œè‡ªåŠ¨è¿è¡Œåˆå§‹åŒ–è„šæœ¬

3. **ä¼˜åŒ–é…ç½®åº”ç”¨**:
   - å¯ç”¨WALæ¨¡å¼
   - é…ç½®æ€§èƒ½ä¼˜åŒ–å‚æ•°

### éªŒè¯ç¬¬ä¸€æ¬¡éƒ¨ç½²

```bash
# 1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs gymapp

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡º:
# ğŸ“Š æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...
# âš ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆå§‹åŒ–...
# âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
# ğŸ”§ åº”ç”¨æ•°æ®åº“ä¼˜åŒ–é…ç½®...
# ğŸ¯ å¯åŠ¨åº”ç”¨æœåŠ¡å™¨...

# 2. æ£€æŸ¥æ•°æ®åº“è¡¨
docker-compose exec gymapp sqlite3 /app/db/db.production.sqlite3 ".tables"

# åº”è¯¥çœ‹åˆ°:
# body_parts  sets  users  workout_body_parts  workout_sets  workouts

# 3. æµ‹è¯•API
curl http://localhost:3000/api/health
```

### å¦‚æœåˆå§‹åŒ–å¤±è´¥

å¦‚æœæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œå®¹å™¨ä¼šå¯åŠ¨å¤±è´¥ã€‚æ£€æŸ¥æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
docker-compose logs gymapp

# å¸¸è§é—®é¢˜ï¼š
# 1. æƒé™é—®é¢˜ - æ£€æŸ¥volumeæŒ‚è½½æƒé™
# 2. ç¯å¢ƒå˜é‡ç¼ºå¤± - æ£€æŸ¥AUTH_SECRETç­‰
# 3. ç£ç›˜ç©ºé—´ä¸è¶³ - æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´
```

### 3. æ•°æ®åº“åˆå§‹åŒ–

é¦–æ¬¡å¯åŠ¨ååˆå§‹åŒ–æ•°æ®åº“ï¼š

```bash
# è¿›å…¥å®¹å™¨
docker-compose exec gymapp sh

# åˆå§‹åŒ–æ•°æ®åº“
cd /app
pnpm run db:init

# é€€å‡ºå®¹å™¨
exit
```

## éƒ¨ç½²é€‰é¡¹

### é€‰é¡¹1: Docker Composeï¼ˆæ¨èï¼‰

```yaml
# docker-compose.yml å·²é…ç½®åŒ…å«ï¼š
# - è‡ªåŠ¨é‡å¯
# - å¥åº·æ£€æŸ¥
# - æ•°æ®æŒä¹…åŒ–
# - ç½‘ç»œéš”ç¦»
```

### é€‰é¡¹2: ç›´æ¥Dockerå‘½ä»¤

```bash
# æ„å»ºé•œåƒ
docker build -t gymapp ./frontend

# è¿è¡Œå®¹å™¨
docker run -d \
  --name gymapp \
  -p 3000:3000 \
  -e AUTH_SECRET="your-secret" \
  -e DATABASE_PATH="/app/db.production.sqlite3" \
  -e NEXTAUTH_URL="https://yourdomain.com" \
  -v $(pwd)/db:/app/db \
  gymapp
```

### é€‰é¡¹3: ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“

ä¿®æ”¹ç¯å¢ƒå˜é‡ä½¿ç”¨å¤–éƒ¨SQLiteæ–‡ä»¶ï¼š

```bash
# ä½¿ç”¨ä¸»æœºç›®å½•æŒ‚è½½
DATABASE_PATH=/host/db/production.sqlite3
```

## ç»´æŠ¤å‘½ä»¤

### å¤‡ä»½æ•°æ®åº“

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# å¤‡ä»½æ•°æ®åº“
cp db/production.sqlite3 db/backup-$(date +%Y%m%d).sqlite3

# é‡å¯æœåŠ¡
docker-compose up -d
```

### æ›´æ–°åº”ç”¨

```bash
# é‡æ–°æ„å»ºé•œåƒ
docker-compose build --no-cache

# é‡å¯æœåŠ¡
docker-compose up -d
```

### æŸ¥çœ‹å¥åº·çŠ¶æ€

```bash
# å¥åº·æ£€æŸ¥API
curl http://localhost:3000/api/health

# Dockerå¥åº·çŠ¶æ€
docker-compose ps
docker stats
```

## ç”Ÿäº§ç¯å¢ƒé…ç½®

### åå‘ä»£ç†ï¼ˆNginxï¼‰

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### SSLè¯ä¹¦ï¼ˆLet's Encryptï¼‰

```bash
# ä½¿ç”¨certbot
certbot --nginx -d yourdomain.com
```

### ç¯å¢ƒå˜é‡å®‰å…¨

- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- ä½¿ç”¨å¼ºå¯†ç ä½œä¸ºAUTH_SECRET
- å®šæœŸè½®æ¢å¯†é’¥
- é™åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶æƒé™

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :3000
   # ä¿®æ”¹docker-compose.ymlä¸­çš„ç«¯å£æ˜ å°„
   ```

2. **æ•°æ®åº“æƒé™é—®é¢˜**
   ```bash
   # ç¡®ä¿dbç›®å½•æƒé™æ­£ç¡®
   chmod 755 db/
   ```

3. **å†…å­˜ä¸è¶³**
   ```bash
   # æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
   docker stats
   # å¢åŠ å†…å­˜é™åˆ¶ï¼ˆåœ¨docker-compose.ymlä¸­ï¼‰
   deploy:
     resources:
       limits:
         memory: 512M
   ```

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs gymapp

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose logs gymapp | grep -i error

# å®æ—¶ç›‘æ§
docker-compose logs -f gymapp
```

## ç›‘æ§å’Œå‘Šè­¦

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

- GET `/api/health` - åŸºç¡€å¥åº·æ£€æŸ¥
- è¿”å›åº”ç”¨çŠ¶æ€ã€è¿è¡Œæ—¶é—´ã€ç‰ˆæœ¬ä¿¡æ¯

### å»ºè®®ç›‘æ§é¡¹

- å®¹å™¨å¥åº·çŠ¶æ€
- å†…å­˜ä½¿ç”¨ç‡
- CPUä½¿ç”¨ç‡
- ç£ç›˜ç©ºé—´
- æ•°æ®åº“è¿æ¥çŠ¶æ€

---

**æœ€åæ›´æ–°ï¼š** 2026å¹´1æœˆ2æ—¥ (æ·»åŠ CI/CDéƒ¨ç½²æµç¨‹)
