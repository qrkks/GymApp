# 数据库迁移问题解决方案

## 问题描述

运行 `pnpm db:migrate` 时出现错误：
```
DrizzleError: Failed to run the query 'CREATE TABLE `body_parts` ...'
cause: SqliteError: table `body_parts` already exists
```

## 问题原因

1. 数据库表已经通过 `init-db.js` 或其他方式创建
2. Drizzle 迁移系统不知道这些表已经存在
3. 迁移记录表（`__drizzle_migrations`）可能未正确记录

## 解决方案

### 方案 1：使用 `db:push`（推荐）

`db:push` 会直接同步 schema 到数据库，不依赖迁移历史：

```bash
cd frontend
pnpm db:push
```

**优点：**
- 简单直接
- 不需要管理迁移历史
- 适合开发环境

**缺点：**
- 不适合生产环境（无法追踪变更历史）

### 方案 2：手动标记迁移为已执行

如果表结构已经正确，可以手动在迁移记录表中标记：

```sql
-- 连接到数据库
sqlite3 db.sqlite

-- 创建迁移记录表（如果不存在）
CREATE TABLE IF NOT EXISTS __drizzle_migrations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  hash TEXT NOT NULL,
  created_at INTEGER
);

-- 标记迁移为已执行（使用迁移文件的哈希值）
-- 哈希值可以从 drizzle/meta/_journal.json 中获取
INSERT INTO __drizzle_migrations (hash, created_at) 
VALUES ('0000_chubby_vertigo', strftime('%s', 'now'));
```

### 方案 3：删除现有表，重新运行迁移

⚠️ **警告：这会删除所有数据！**

```bash
cd frontend
# 删除数据库文件
rm db.sqlite

# 重新运行迁移
pnpm db:migrate
```

### 方案 4：删除迁移文件（如果表结构已正确）

如果表结构已经正确，可以删除迁移文件：

```bash
cd frontend
# 删除迁移文件
rm -rf drizzle/0000_chubby_vertigo.sql
rm -rf drizzle/meta/0000_snapshot.json

# 更新 journal
# 编辑 drizzle/meta/_journal.json，移除对应的迁移记录
```

## 推荐做法

### 开发环境
使用 `db:push`：
```bash
pnpm db:push
```

### 生产环境
1. 使用迁移系统（`db:migrate`）
2. 确保迁移记录表正确维护
3. 不要手动创建表

## 当前项目建议

由于项目已经通过 `init-db.js` 创建了表，建议：

1. **短期方案**：使用 `db:push` 同步 schema
2. **长期方案**：统一使用 Drizzle 迁移系统，移除 `init-db.js` 脚本

## 验证

迁移成功后，可以验证：

```bash
# 检查表是否存在
sqlite3 db.sqlite ".tables"

# 检查迁移记录
sqlite3 db.sqlite "SELECT * FROM __drizzle_migrations;"
```

