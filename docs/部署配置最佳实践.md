# éƒ¨ç½²é…ç½®æœ€ä½³å®žè·µ

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜Žå¦‚ä½•å°† Docker Compose æ–‡ä»¶å’ŒçŽ¯å¢ƒå˜é‡å®‰å…¨ã€è§„èŒƒåœ°éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œéµå¾ªè¡Œä¸šæœ€ä½³å®žè·µã€‚

## ðŸŽ¯ æ ¸å¿ƒåŽŸåˆ™

1. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šé…ç½®æ–‡ä»¶ï¼ˆcomposeï¼‰ä¸Žæ•æ„Ÿä¿¡æ¯ï¼ˆçŽ¯å¢ƒå˜é‡ï¼‰åˆ†ç¦»
2. **å®‰å…¨æ€§**ï¼šæ•æ„Ÿä¿¡æ¯ä¸æäº¤åˆ° Gitï¼Œä½¿ç”¨å®‰å…¨å­˜å‚¨
3. **å¯ç»´æŠ¤æ€§**ï¼šé…ç½®æ˜“äºŽæ›´æ–°å’Œç®¡ç†
4. **å¯è¿½æº¯æ€§**ï¼šé…ç½®æ–‡ä»¶ç‰ˆæœ¬åŒ–ï¼ŒçŽ¯å¢ƒå˜é‡æœ‰æ˜Žç¡®æ¥æº

## ðŸ“ æŽ¨èçš„æœåŠ¡å™¨ç›®å½•ç»“æž„

```
/home/{USER}/gymapp/
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ deploy/
â”‚       â”œâ”€â”€ docker-compose.yml      # âœ… ç‰ˆæœ¬æŽ§åˆ¶ï¼Œå¯æäº¤åˆ° Git
â”‚       â”œâ”€â”€ docker-compose.override.yml  # å¯é€‰ï¼šæœ¬åœ°è¦†ç›–é…ç½®
â”‚       â”œâ”€â”€ deploy.sh               # éƒ¨ç½²è„šæœ¬
â”‚       â””â”€â”€ README.md
â”œâ”€â”€ .env                            # âŒ ä¸æäº¤åˆ° Gitï¼ŒæœåŠ¡å™¨æœ¬åœ°æ–‡ä»¶
â”œâ”€â”€ .env.example                    # âœ… æ¨¡æ¿æ–‡ä»¶ï¼Œå¯æäº¤åˆ° Git
â””â”€â”€ secrets/                        # å¯é€‰ï¼šé«˜çº§å¯†é’¥ç®¡ç†
    â””â”€â”€ .env.production
```

## ðŸ” çŽ¯å¢ƒå˜é‡ç®¡ç†æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼š`.env` æ–‡ä»¶ï¼ˆæŽ¨èç”¨äºŽä¸­å°åž‹é¡¹ç›®ï¼‰

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æŽ¥ï¼Œæ˜“äºŽç®¡ç†
- Docker Compose åŽŸç”Ÿæ”¯æŒ
- é€‚åˆå•æœåŠ¡å™¨éƒ¨ç½²

**å®žçŽ°æ­¥éª¤**ï¼š

1. **åˆ›å»º `.env.example` æ¨¡æ¿**ï¼ˆæäº¤åˆ° Gitï¼‰ï¼š
```bash
# frontend/deploy/.env.example
AUTH_SECRET=your-auth-secret-here
POSTGRES_PASSWORD=your-postgres-password-here
NEXTAUTH_URL=https://yourdomain.com
DOMAIN_NAME=yourdomain.com
NODE_ENV=production
```

2. **åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»º `.env` æ–‡ä»¶**ï¼ˆä¸æäº¤åˆ° Gitï¼‰ï¼š
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /home/{USER}/gymapp/frontend/deploy
cp .env.example .env
nano .env  # ç¼–è¾‘å¡«å…¥çœŸå®žå€¼
chmod 600 .env  # é™åˆ¶æƒé™ï¼Œåªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
```

3. **ä¿®æ”¹ `docker-compose.yml` ä½¿ç”¨ `.env` æ–‡ä»¶**ï¼š
```yaml
services:
  gymapp:
    env_file:
      - .env  # ä»Ž .env æ–‡ä»¶åŠ è½½çŽ¯å¢ƒå˜é‡
    environment:
      - AUTH_SECRET=${AUTH_SECRET}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/gymapp
      # ... å…¶ä»–å˜é‡
```

4. **æ›´æ–° `.gitignore`**ï¼š
```gitignore
# çŽ¯å¢ƒå˜é‡æ–‡ä»¶
frontend/deploy/.env
*.env
!.env.example
```

### æ–¹æ¡ˆ 2ï¼šDocker Secretsï¼ˆæŽ¨èç”¨äºŽç”Ÿäº§çŽ¯å¢ƒï¼‰

**ä¼˜ç‚¹**ï¼š
- æ›´å®‰å…¨ï¼Œå¯†é’¥ä¸å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿ
- é€‚åˆå¤šæœåŠ¡å™¨ã€å®¹å™¨ç¼–æŽ’åœºæ™¯
- æ”¯æŒå¯†é’¥è½®æ¢

**å®žçŽ°æ­¥éª¤**ï¼š

1. **åˆ›å»ºå¯†é’¥æ–‡ä»¶**ï¼š
```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯†é’¥ç›®å½•
mkdir -p /home/{USER}/gymapp/secrets
chmod 700 /home/{USER}/gymapp/secrets

# åˆ›å»ºå¯†é’¥æ–‡ä»¶
echo "your-auth-secret" | docker secret create auth_secret -
echo "your-postgres-password" | docker secret create postgres_password -
```

2. **åœ¨ `docker-compose.yml` ä¸­ä½¿ç”¨ secrets**ï¼š
```yaml
services:
  gymapp:
    secrets:
      - auth_secret
      - postgres_password
    environment:
      - AUTH_SECRET_FILE=/run/secrets/auth_secret
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
```

### æ–¹æ¡ˆ 3ï¼šçŽ¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆå½“å‰æ–¹æ¡ˆæ”¹è¿›ç‰ˆï¼‰

**ä¼˜ç‚¹**ï¼š
- é€‚åˆ CI/CD è‡ªåŠ¨åŒ–
- å¯†é’¥å­˜å‚¨åœ¨ GitHub Secrets
- éƒ¨ç½²æ—¶åŠ¨æ€æ³¨å…¥

**æ”¹è¿›å»ºè®®**ï¼š

1. **åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæŒä¹…åŒ–çš„ `.env` æ–‡ä»¶**ï¼š
```bash
# GitHub Actions éƒ¨ç½²æ—¶åˆ›å»º/æ›´æ–° .env æ–‡ä»¶
cat > /home/{USER}/gymapp/frontend/deploy/.env << EOF
AUTH_SECRET=${{ secrets.AUTH_SECRET }}
POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
NODE_ENV=production
EOF
chmod 600 /home/{USER}/gymapp/frontend/deploy/.env
```

2. **ä½¿ç”¨ `.env` æ–‡ä»¶è€Œä¸æ˜¯ export**ï¼š
```bash
# åœ¨ deploy.sh ä¸­
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
else
  echo "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨"
  exit 1
fi
```

## ðŸ“¦ Compose æ–‡ä»¶ç®¡ç†

### æœ€ä½³å®žè·µ

1. **ç‰ˆæœ¬æŽ§åˆ¶**ï¼š
   - âœ… `docker-compose.yml` æäº¤åˆ° Git
   - âœ… ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æˆ– Git æ ‡ç­¾ç®¡ç†é…ç½®å˜æ›´
   - âœ… åœ¨æäº¤ä¿¡æ¯ä¸­è¯´æ˜Žé…ç½®å˜æ›´åŽŸå› 

2. **çŽ¯å¢ƒåˆ†ç¦»**ï¼š
```yaml
# docker-compose.yml (åŸºç¡€é…ç½®)
version: '3.8'
services:
  gymapp:
    # åŸºç¡€é…ç½®

# docker-compose.prod.yml (ç”Ÿäº§çŽ¯å¢ƒè¦†ç›–)
services:
  gymapp:
    environment:
      - NODE_ENV=production
    deploy:
      resources:
        limits:
          memory: 1G
```

3. **ä½¿ç”¨çŽ¯å¢ƒå˜é‡å¼•ç”¨**ï¼š
```yaml
services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # ä½¿ç”¨é»˜è®¤å€¼
      POSTGRES_DB: ${POSTGRES_DB:-gymapp}
```

## ðŸš€ æ”¹è¿›çš„éƒ¨ç½²æµç¨‹

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ `.env` æ–‡ä»¶ï¼ˆæŽ¨èï¼‰

**GitHub Actions æ”¹è¿›**ï¼š

```yaml
- name: Deploy to server
  run: |
    sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
      DEPLOY_DIR="/home/${{ secrets.SERVER_USER }}/gymapp"
      cd "$DEPLOY_DIR/frontend/deploy"
      
      # åˆ›å»º/æ›´æ–° .env æ–‡ä»¶
      cat > .env << 'ENVEOF'
      AUTH_SECRET=${{ secrets.AUTH_SECRET }}
      POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
      NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
      DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
      NODE_ENV=production
      ENVEOF
      
      chmod 600 .env
      
      # ä½¿ç”¨ .env æ–‡ä»¶å¯åŠ¨
      docker compose --env-file .env up -d
    EOF
```

**æœåŠ¡å™¨ä¸Šçš„ `deploy.sh` æ”¹è¿›**ï¼š

```bash
#!/bin/bash
set -e

COMPOSE_FILE="docker-compose.yml"
ENV_FILE=".env"
PROJECT_NAME="gymapp"

# æ£€æŸ¥ .env æ–‡ä»¶
if [ ! -f "$ENV_FILE" ]; then
  echo "âŒ é”™è¯¯: $ENV_FILE æ–‡ä»¶ä¸å­˜åœ¨"
  echo "è¯·å…ˆåˆ›å»º $ENV_FILE æ–‡ä»¶ï¼ˆå‚è€ƒ .env.exampleï¼‰"
  exit 1
fi

# éªŒè¯å¿…éœ€çš„çŽ¯å¢ƒå˜é‡
source "$ENV_FILE"
required_vars=("AUTH_SECRET" "POSTGRES_PASSWORD" "NEXTAUTH_URL" "DOMAIN_NAME")
for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    echo "âŒ é”™è¯¯: $var æœªåœ¨ $ENV_FILE ä¸­è®¾ç½®"
    exit 1
  fi
done

# ä½¿ç”¨ .env æ–‡ä»¶æ‰§è¡Œ docker compose
docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" -p "$PROJECT_NAME" "$@"
```

### æ–¹æ¡ˆ Bï¼šé¦–æ¬¡éƒ¨ç½²æ—¶åˆå§‹åŒ–

**åˆ›å»ºåˆå§‹åŒ–è„šæœ¬**ï¼š

```bash
#!/bin/bash
# frontend/deploy/init-env.sh

ENV_FILE=".env"
ENV_EXAMPLE=".env.example"

if [ ! -f "$ENV_FILE" ]; then
  echo "ðŸ“ é¦–æ¬¡éƒ¨ç½²ï¼Œåˆ›å»º $ENV_FILE æ–‡ä»¶..."
  
  if [ -f "$ENV_EXAMPLE" ]; then
    cp "$ENV_EXAMPLE" "$ENV_FILE"
    echo "âœ… å·²ä»Ž $ENV_EXAMPLE åˆ›å»º $ENV_FILE"
    echo "âš ï¸  è¯·ç¼–è¾‘ $ENV_FILE å¹¶å¡«å…¥çœŸå®žå€¼"
    exit 1
  else
    # ä»ŽçŽ¯å¢ƒå˜é‡åˆ›å»ºï¼ˆCI/CD åœºæ™¯ï¼‰
    cat > "$ENV_FILE" << EOF
AUTH_SECRET=${AUTH_SECRET}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
NEXTAUTH_URL=${NEXTAUTH_URL}
DOMAIN_NAME=${DOMAIN_NAME}
NODE_ENV=production
EOF
    chmod 600 "$ENV_FILE"
    echo "âœ… å·²åˆ›å»º $ENV_FILE"
  fi
fi
```

## ðŸ”’ å®‰å…¨æœ€ä½³å®žè·µ

### 1. æ–‡ä»¶æƒé™
```bash
# .env æ–‡ä»¶æƒé™ï¼šåªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chmod 600 .env

# éƒ¨ç½²ç›®å½•æƒé™
chmod 700 /home/{USER}/gymapp
```

### 2. å¯†é’¥ç®¡ç†
- âœ… ä½¿ç”¨å¼ºå¯†ç ç”Ÿæˆå™¨
- âœ… å®šæœŸè½®æ¢å¯†é’¥
- âœ… ä¸åŒçŽ¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
- âŒ ä¸è¦åœ¨æ—¥å¿—ä¸­è¾“å‡ºå¯†é’¥
- âŒ ä¸è¦é€šè¿‡ä¸å®‰å…¨çš„é€šé“ä¼ è¾“å¯†é’¥

### 3. å¤‡ä»½ç­–ç•¥
```bash
# å¤‡ä»½ .env æ–‡ä»¶ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
tar -czf env-backup-$(date +%Y%m%d).tar.gz .env
# å­˜å‚¨åˆ°å®‰å…¨ä½ç½®ï¼ˆå¦‚åŠ å¯†çš„äº‘å­˜å‚¨ï¼‰
```

## ðŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | æ˜“ç”¨æ€§ | é€‚ç”¨åœºæ™¯ | æŽ¨èåº¦ |
|------|--------|--------|----------|--------|
| `.env` æ–‡ä»¶ | â­â­â­ | â­â­â­â­â­ | ä¸­å°åž‹é¡¹ç›®ï¼Œå•æœåŠ¡å™¨ | â­â­â­â­â­ |
| Docker Secrets | â­â­â­â­â­ | â­â­â­ | ç”Ÿäº§çŽ¯å¢ƒï¼Œå¤šæœåŠ¡å™¨ | â­â­â­â­ |
| çŽ¯å¢ƒå˜é‡æ³¨å…¥ | â­â­â­ | â­â­â­â­ | CI/CD è‡ªåŠ¨åŒ– | â­â­â­ |

## ðŸŽ¯ æŽ¨èæ–¹æ¡ˆæ€»ç»“

**å¯¹äºŽå½“å‰é¡¹ç›®ï¼ŒæŽ¨èä½¿ç”¨ `.env` æ–‡ä»¶æ–¹æ¡ˆ**ï¼š

1. âœ… ç®€å•æ˜“ç”¨ï¼Œç¬¦åˆ Docker Compose æœ€ä½³å®žè·µ
2. âœ… çŽ¯å¢ƒå˜é‡æŒä¹…åŒ–ï¼Œé‡å¯å®¹å™¨ä¸éœ€è¦é‡æ–°è®¾ç½®
3. âœ… å®‰å…¨æ€§ï¼šæ–‡ä»¶æƒé™æŽ§åˆ¶ + ä¸æäº¤åˆ° Git
4. âœ… æ˜“äºŽç»´æŠ¤ï¼šæ¨¡æ¿æ–‡ä»¶ + ç‰ˆæœ¬æŽ§åˆ¶
5. âœ… å…¼å®¹çŽ°æœ‰ CI/CD æµç¨‹

## ðŸ“ å®žæ–½æ­¥éª¤

1. **åˆ›å»º `.env.example` æ¨¡æ¿æ–‡ä»¶**
2. **æ›´æ–° `docker-compose.yml` ä½¿ç”¨ `env_file`**
3. **ä¿®æ”¹ GitHub Actions åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»º `.env` æ–‡ä»¶**
4. **æ›´æ–° `deploy.sh` è„šæœ¬æ”¯æŒ `.env` æ–‡ä»¶**
5. **æ›´æ–° `.gitignore` æŽ’é™¤ `.env` æ–‡ä»¶**
6. **æµ‹è¯•éƒ¨ç½²æµç¨‹**

## ðŸ”— ç›¸å…³æ–‡æ¡£

- [Docker Compose çŽ¯å¢ƒå˜é‡æ–‡æ¡£](https://docs.docker.com/compose/environment-variables/)
- [12-Factor App é…ç½®åŽŸåˆ™](https://12factor.net/config)
- [OWASP å¯†é’¥ç®¡ç†æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)

