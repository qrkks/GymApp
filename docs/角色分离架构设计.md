# 角色分离架构设计

## 🎯 核心设计理念

**GitHub Secrets** 和 **.env 文件** 完全分离，各自承担不同的职责。

## 📊 角色划分

### GitHub Secrets（部署基础设施）

**职责**：如何访问和部署到服务器

**包含的 Secrets**：
```yaml
SERVER_IP: "39.107.126.13"           # 服务器 IP 地址
SERVER_USER: "ubuntu"                # SSH 用户名
SERVER_PASSWORD: "your-ssh-password" # SSH 密码
```

**用途**：
- ✅ SSH 连接到服务器
- ✅ 传输 Docker 镜像
- ✅ 传输部署文件（compose 等）
- ✅ 执行部署命令

**特点**：
- 🔒 敏感但相对稳定（不经常变更）
- 🔒 与代码仓库绑定（谁可以部署）
- 🔒 可以多人共享（团队部署权限）

---

### .env 文件（应用运行时配置）

**职责**：应用运行需要什么配置

**包含的变量**：
```bash
# frontend/deploy/.env
AUTH_SECRET=your-generated-secret-key
POSTGRES_PASSWORD=your-database-password
NEXTAUTH_URL=https://yourdomain.com
DOMAIN_NAME=yourdomain.com
NODE_ENV=production
```

**用途**：
- ✅ 应用运行时环境变量
- ✅ 数据库连接配置
- ✅ 认证配置
- ✅ 域名和 URL 配置

**特点**：
- 🔒 高度敏感（应用密钥、数据库密码）
- 🔒 可能经常变更（配置调整、密钥轮换）
- 🔒 服务器本地管理（不进入 Git）
- 🔒 每个环境可能不同（dev/staging/prod）

---

## 🏗️ 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    GitHub Repository                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │  GitHub Secrets (部署凭证)                        │  │
│  │  - SERVER_IP                                      │  │
│  │  - SERVER_USER                                    │  │
│  │  - SERVER_PASSWORD                                │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Git 代码（包含 compose 文件）                     │  │
│  │  - docker-compose.yml                             │  │
│  │  - .env.example (模板)                            │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        │
                        │ GitHub Actions
                        │ (构建 + 部署)
                        ▼
┌─────────────────────────────────────────────────────────┐
│                     服务器                                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  /home/{USER}/gymapp/frontend/deploy/              │  │
│  │  ├── docker-compose.yml  (从 Git 更新)            │  │
│  │  ├── .env              (服务器本地，手动管理)      │  │
│  │  └── deploy.sh                                      │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 工作流程

### 首次部署

1. **设置 GitHub Secrets**（一次性）
   ```yaml
   # 在 GitHub 仓库设置
   SERVER_IP: "39.107.126.13"
   SERVER_USER: "ubuntu"
   SERVER_PASSWORD: "your-password"
   ```

2. **在服务器上创建 .env**（手动）
   ```bash
   # SSH 到服务器
   ssh user@server
   
   # 进入部署目录
   cd /home/{USER}/gymapp/frontend/deploy
   
   # 从模板创建 .env
   cp .env.example .env
   
   # 编辑 .env，填入真实值
   nano .env
   # 设置：
   # AUTH_SECRET=...
   # POSTGRES_PASSWORD=...
   # NEXTAUTH_URL=...
   # DOMAIN_NAME=...
   
   # 设置权限
   chmod 600 .env
   ```

3. **触发部署**（GitHub Actions）
   ```bash
   # 推送代码到 main 分支
   git push origin main
   ```
   - GitHub Actions 自动：
     - 构建 Docker 镜像
     - 传输镜像和 compose 文件到服务器
     - 使用服务器上的 .env 启动容器

### 后续部署

1. **代码更新**（自动）
   ```bash
   git push origin main
   ```
   - GitHub Actions 自动部署
   - Compose 文件自动更新
   - .env 文件保持不变

2. **配置更新**（手动，如需要）
   ```bash
   # SSH 到服务器
   ssh user@server
   cd /home/{USER}/gymapp/frontend/deploy
   
   # 编辑 .env
   nano .env
   
   # 重启容器使配置生效
   docker compose restart
   ```

---

## ✅ 优势

### 1. 职责清晰
- **GitHub Secrets** = "如何部署"
- **.env 文件** = "如何运行"
- 两者互不干扰

### 2. 安全性提升
- ✅ 应用密钥不存储在 GitHub（即使仓库被泄露）
- ✅ 服务器配置完全本地化
- ✅ 符合最小权限原则

### 3. 灵活性
- ✅ 可以随时修改服务器配置，不影响部署流程
- ✅ 不同服务器可以使用不同配置
- ✅ 配置变更不需要修改 GitHub Secrets

### 4. 可维护性
- ✅ 配置变更流程简单（直接编辑 .env）
- ✅ 不需要考虑覆盖冲突
- ✅ 部署和配置管理分离

---

## ⚠️ 注意事项

### 1. .env 文件管理

**必须手动管理**：
- ❌ GitHub Actions 不会自动创建或更新
- ✅ 需要服务器管理员手动操作
- ✅ 需要文档说明如何创建和更新

**建议**：
```bash
# 创建初始化脚本（可选）
./deploy.sh init-env

# 或提供详细文档
# 参考 .env.example 创建 .env
```

### 2. 首次部署检查

**GitHub Actions 需要检查**：
```yaml
# 部署前检查 .env 是否存在
if [ ! -f .env ]; then
  echo "❌ .env 文件不存在"
  echo "请先创建 .env 文件（参考 .env.example）"
  exit 1
fi
```

### 3. 配置备份

**建议定期备份**：
```bash
# 备份 .env 文件
tar -czf env-backup-$(date +%Y%m%d).tar.gz .env
# 存储到安全位置
```

### 4. 团队协作

**如果多人需要管理配置**：
- ✅ 使用配置管理工具（Ansible, Terraform）
- ✅ 使用密钥管理服务（Vault, AWS Secrets Manager）
- ✅ 建立配置变更流程和文档

---

## 📝 GitHub Actions 简化

### 修改前（当前）

```yaml
# 需要传递所有环境变量
export AUTH_SECRET="${{ secrets.AUTH_SECRET }}"
export NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
docker compose up -d
```

### 修改后（新方案）

```yaml
# 只使用服务器上的 .env
cd "$DEPLOY_DIR/frontend/deploy"

# 检查 .env 是否存在
if [ ! -f .env ]; then
  echo "❌ .env 文件不存在"
  echo "请先创建 .env 文件（参考 .env.example）"
  exit 1
fi

# 使用 .env 启动
docker compose --env-file .env up -d
```

**GitHub Secrets 简化**：
```yaml
# 只需要这些
secrets:
  SERVER_IP: "..."
  SERVER_USER: "..."
  SERVER_PASSWORD: "..."
```

---

## 🎯 实施检查清单

- [ ] 从 GitHub Secrets 中移除项目环境变量
  - [ ] 移除 `AUTH_SECRET`
  - [ ] 移除 `POSTGRES_PASSWORD`
  - [ ] 移除 `NEXTAUTH_URL`
  - [ ] 移除 `DOMAIN_NAME`（如果不需要在 Actions 中使用）

- [ ] 创建 `.env.example` 模板文件
  - [ ] 包含所有必需的环境变量
  - [ ] 添加注释说明
  - [ ] 提交到 Git

- [ ] 更新 GitHub Actions 工作流
  - [ ] 移除环境变量传递
  - [ ] 添加 .env 文件检查
  - [ ] 使用 `--env-file .env` 启动容器

- [ ] 更新部署文档
  - [ ] 说明如何创建 .env
  - [ ] 说明如何更新配置
  - [ ] 说明配置备份策略

- [ ] 在服务器上创建 .env 文件
  - [ ] 从 .env.example 复制
  - [ ] 填入真实值
  - [ ] 设置正确权限（chmod 600）

---

## 🔗 相关文档

- [部署配置最佳实践](./部署配置最佳实践.md)
- [服务器配置管理方案](./服务器配置管理方案.md)
- [部署配置讨论清单](./部署配置讨论清单.md)

