# 简单部署方案

## 目标

用最简单、最健壮的方式替换和启动容器，先确保容器能正常运行，后续再优化。

## 部署命令

**最简单的部署流程**：

```bash
cd /path/to/deploy/frontend/deploy

# 1. 停止并删除旧容器
docker compose down

# 2. 启动新容器
docker compose up -d

# 完成！让 Docker 自己处理健康检查
```

就这么简单！

## 配置说明

### docker-compose.yml

- **健康检查**：配置了 `start_period: 120s`，给应用足够时间启动
- **重启策略**：`restart: unless-stopped`，容器异常退出会自动重启
- **依赖等待**：`depends_on` 确保 PostgreSQL 健康后才启动应用

### Dockerfile

- **健康检查**：在镜像层面配置，Docker 会自动监控
- **启动脚本**：`start.sh` 处理数据库迁移和应用启动

## 工作原理

1. **停止旧容器**：`docker compose down` 会：
   - 停止所有容器
   - 删除容器（但保留数据卷）
   - 不会删除镜像

2. **启动新容器**：`docker compose up -d` 会：
   - 使用最新的镜像创建新容器
   - 自动应用所有配置
   - 在后台运行

3. **健康检查**：Docker 会自动：
   - 等待 `start_period`（120秒）后才开始检查
   - 每 30 秒检查一次
   - 失败 5 次后才标记为不健康

## 验证部署

部署后，可以简单检查：

```bash
# 查看容器状态
docker compose ps

# 查看日志（如果容器启动有问题）
docker compose logs gymapp

# 手动测试健康检查端点
curl http://localhost:3000/api/health
```

## 优势

- ✅ **简单**：只有两个命令
- ✅ **健壮**：Docker 自动处理健康检查和重启
- ✅ **可靠**：不依赖外部脚本，减少失败点
- ✅ **快速**：没有复杂的等待和检查逻辑

## 注意事项

- 首次部署需要确保 `.env` 文件已正确配置
- 如果容器启动失败，查看日志：`docker compose logs gymapp`
- 健康检查在 120 秒内不会失败，给应用足够启动时间

---

**原则**：先让容器能跑起来，再优化细节。

