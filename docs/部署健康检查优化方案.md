# éƒ¨ç½²å¥åº·æ£€æŸ¥ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜æè¿°

åœ¨ CI/CD éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼š
```
âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP 000000)
```

ä½†æ‰‹åŠ¨å¯åŠ¨å®¹å™¨æ—¶æ²¡æœ‰é—®é¢˜ã€‚

## é—®é¢˜åŸå› 

åº”ç”¨å¯åŠ¨éœ€è¦æ—¶é—´å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. **ç­‰å¾… PostgreSQL è¿æ¥**ï¼šæœ€å¤š 60 ç§’ï¼ˆ30 æ¬¡å°è¯• Ã— 2 ç§’ï¼‰
2. **è¿è¡Œæ•°æ®åº“è¿ç§»**ï¼š10-30 ç§’ï¼ˆå–å†³äºè¿ç§»å¤æ‚åº¦ï¼‰
3. **å¯åŠ¨ Next.js æœåŠ¡å™¨**ï¼š10-20 ç§’

**æ€»è®¡å¯èƒ½éœ€è¦ 60-90 ç§’**ï¼Œä½†ä¹‹å‰çš„é…ç½®åªç­‰å¾…äº† 40 ç§’ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. å¢åŠ  Docker å¥åº·æ£€æŸ¥çš„å¯åŠ¨ç­‰å¾…æ—¶é—´

å·²æ›´æ–°ä»¥ä¸‹æ–‡ä»¶ï¼š

- `frontend/docker-compose.yml`: `start_period: 40s` â†’ `start_period: 120s`
- `frontend/Dockerfile`: `--start-period=40s` â†’ `--start-period=120s`

è¿™ç¡®ä¿ Docker åœ¨ 120 ç§’å†…ä¸ä¼šå°†å¥åº·æ£€æŸ¥å¤±è´¥è§†ä¸ºå®¹å™¨ä¸å¥åº·ã€‚

### 2. åˆ›å»ºå¥åº·æ£€æŸ¥ç­‰å¾…è„šæœ¬

åˆ›å»ºäº† `frontend/scripts/wait-for-health.sh` è„šæœ¬ï¼Œç”¨äº CI/CD éƒ¨ç½²æ—¶ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨ã€‚

## åœ¨ CI/CD ä¸­ä½¿ç”¨

### æ–¹æ³• 1ï¼šä½¿ç”¨å¥åº·æ£€æŸ¥è„šæœ¬ï¼ˆæ¨èï¼‰

åœ¨ GitHub Actions æˆ–å…¶ä»– CI/CD è„šæœ¬ä¸­ï¼Œåœ¨å¯åŠ¨å®¹å™¨åä½¿ç”¨ç­‰å¾…è„šæœ¬ï¼š

```bash
# å¯åŠ¨å®¹å™¨
docker compose up -d

# ç­‰å¾…åº”ç”¨å¥åº·ï¼ˆæœ€å¤šç­‰å¾… 90 ç§’ï¼š30 æ¬¡ Ã— 3 ç§’ï¼‰
cd /path/to/deploy
chmod +x scripts/wait-for-health.sh
./scripts/wait-for-health.sh http://localhost:3000/api/health 30 3

# æ£€æŸ¥é€€å‡ºç 
if [ $? -eq 0 ]; then
    echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
else
    echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"
    docker compose logs gymapp
    exit 1
fi
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ Docker Compose çš„å¥åº·æ£€æŸ¥

Docker Compose ä¼šè‡ªåŠ¨ä½¿ç”¨é…ç½®çš„å¥åº·æ£€æŸ¥ï¼Œä½†éœ€è¦ç­‰å¾… `start_period` æ—¶é—´ï¼š

```bash
# å¯åŠ¨å®¹å™¨
docker compose up -d

# ç­‰å¾…å®¹å™¨å¥åº·ï¼ˆæœ€å¤šç­‰å¾… 120 ç§’ + é‡è¯•æ—¶é—´ï¼‰
timeout 180 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'

# æˆ–è€…ä½¿ç”¨ docker waitï¼ˆç­‰å¾…å®¹å™¨é€€å‡ºï¼Œä½†å¥åº·æ£€æŸ¥å¤±è´¥ä¸ä¼šå¯¼è‡´é€€å‡ºï¼‰
# è¿™ç§æ–¹æ³•ä¸é€‚ç”¨ï¼Œå› ä¸ºå®¹å™¨ä¼šæŒç»­è¿è¡Œ
```

### æ–¹æ³• 3ï¼šç®€å•çš„é‡è¯•å¾ªç¯

å¦‚æœæ— æ³•ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„é‡è¯•å¾ªç¯ï¼š

```bash
# å¯åŠ¨å®¹å™¨
docker compose up -d

# ç­‰å¾…åº”ç”¨å¥åº·
max_attempts=30
attempt=1
while [ $attempt -le $max_attempts ]; do
    if curl -f -s http://localhost:3000/api/health > /dev/null 2>&1; then
        echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
        break
    fi
    echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... (å°è¯• $attempt/$max_attempts)"
    sleep 3
    attempt=$((attempt + 1))
done

if [ $attempt -gt $max_attempts ]; then
    echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
    docker compose logs gymapp
    exit 1
fi
```

## éªŒè¯æ­¥éª¤

éƒ¨ç½²åï¼ŒéªŒè¯åº”ç”¨æ˜¯å¦æ­£å¸¸ï¼š

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose ps

# åº”è¯¥çœ‹åˆ°ï¼š
# gymapp-frontend   Up X seconds (healthy)

# 2. æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl http://localhost:3000/api/health

# åº”è¯¥è¿”å›ï¼š
# {"status":"ok","timestamp":"...","uptime":...,"version":"...","environment":"production"}

# 3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker compose logs gymapp

# åº”è¯¥çœ‹åˆ°ï¼š
# âœ… PostgreSQL è¿æ¥æˆåŠŸ
# âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
# ğŸ¯ å¯åŠ¨åº”ç”¨æœåŠ¡å™¨...
# - ready started server on 0.0.0.0:3000
```

## æ—¶é—´é…ç½®è¯´æ˜

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `start_period` | 120s | Docker å¥åº·æ£€æŸ¥å¯åŠ¨ç­‰å¾…æ—¶é—´ |
| `interval` | 30s | å¥åº·æ£€æŸ¥é—´éš” |
| `timeout` | 10s | å•æ¬¡å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ |
| `retries` | 3 | å¥åº·æ£€æŸ¥å¤±è´¥é‡è¯•æ¬¡æ•° |

**æ€»ç­‰å¾…æ—¶é—´**ï¼š`start_period` + (`retries` Ã— `interval`) = 120s + (3 Ã— 30s) = 210sï¼ˆçº¦ 3.5 åˆ†é’Ÿï¼‰

## æ•…éšœæ’é™¤

### å¦‚æœå¥åº·æ£€æŸ¥ä»ç„¶å¤±è´¥

1. **æ£€æŸ¥åº”ç”¨æ—¥å¿—**ï¼š
   ```bash
   docker compose logs gymapp
   ```

2. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**ï¼š
   ```bash
   docker compose exec gymapp pg_isready -h postgres -U postgres
   ```

3. **æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼š
   ```bash
   docker compose exec gymapp curl http://localhost:3000/api/health
   ```

4. **æ£€æŸ¥ç«¯å£æ˜ å°„**ï¼š
   ```bash
   docker compose ps
   # ç¡®è®¤ç«¯å£ 3000 å·²æ­£ç¡®æ˜ å°„
   ```

5. **å¢åŠ ç­‰å¾…æ—¶é—´**ï¼š
   å¦‚æœåº”ç”¨å¯åŠ¨ç‰¹åˆ«æ…¢ï¼Œå¯ä»¥å¢åŠ  `start_period` æˆ–è„šæœ¬çš„ç­‰å¾…æ—¶é—´ã€‚

## ç›¸å…³æ–‡ä»¶

- `frontend/docker-compose.yml` - Docker Compose é…ç½®
- `frontend/Dockerfile` - Docker é•œåƒæ„å»ºé…ç½®
- `frontend/scripts/start.sh` - åº”ç”¨å¯åŠ¨è„šæœ¬
- `frontend/scripts/wait-for-health.sh` - å¥åº·æ£€æŸ¥ç­‰å¾…è„šæœ¬
- `frontend/app/api/health/route.ts` - å¥åº·æ£€æŸ¥ API ç«¯ç‚¹

---

**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ2æ—¥

